import torch
from torch import nn


# å®šä¹‰ç¥ç»ç½‘ç»œNetwork
class NetWork(nn.Module):
    def __init__(self):
        super().__init__()

        # çº¿æ€§å±‚1ï¼šè¾“å…¥å±‚ä¸éšè—å±‚ä¹‹é—´çš„çº¿æ€§å±‚
        self.layer1 = nn.Linear(784, 256)
        # çº¿æ€§å±‚2ï¼šéšè—å±‚ä¸è¾“å‡ºå±‚ä¹‹é—´çš„çº¿æ€§å±‚
        self.layer2 = nn.Linear(256, 10)

    # åœ¨å‰å‘ä¼ æ’­ï¼Œforwardå‡½æ•°ä¸­ï¼Œè¾“å…¥ä¸ºå›¾åƒx
    def forward(self, x):
        x = x.view(-1, 784)  # ä½¿ç”¨viewå‡½æ•°ï¼Œå°†xå±•å¹³
        x = self.layer1(x)  # å°†xè¾“å…¥è‡³layer1
        x = torch.relu(x)  # ä½¿ç”¨reluæ¿€æ´»
        output = self.layer2(x)

        return output

    # è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥å®šä¹‰softmaxå±‚
    # è¿™æ˜¯å› ä¸ºåé¢ä¼šä½¿ç”¨CrossEntropyLossæŸå¤±å‡½æ•°
    # åœ¨è¿™ä¸ªæŸå¤±å‡½æ•°ä¸­ï¼Œä¼šå®ç°softmaxçš„è®¡ç®—
    # åŒå­¦ä»¬äº†è§£è¿™ä¸€æƒ…å†µå°±å¯ä»¥äº†ã€‚


# æ‰‹åŠ¨çš„éå†æ¨¡å‹ä¸­çš„å„ä¸ªç»“æ„ï¼Œå¹¶è®¡ç®—å¯ä»¥è®­ç»ƒçš„å‚æ•°
def print_parameters(model):
    cnt = 0
    for name, layer in model.named_children():  # éå†æ¯ä¸€å±‚
        # æ‰“å°å±‚çš„åç§°å’Œè¯¥å±‚ä¸­åŒ…å«çš„å¯è®­ç»ƒå‚æ•°
        # * named_children(): è´Ÿè´£å®è§‚å±‚é¢ï¼Œå¯»æ‰¾ç½‘ç»œåŒ…å«å“ªäº›â€œå±‚â€ã€‚
        # * parameters(): è´Ÿè´£å¾®è§‚å±‚é¢ï¼Œå¯»æ‰¾å±‚é‡Œé¢åŒ…å«å“ªäº›â€œæ•°å­—çŸ©é˜µâ€ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦è®­ç»ƒçš„é‚£ä¸ª w å’Œ bï¼‰ã€‚
        print(f"layer({name}) parameters:")
        # layer(layer1) parameters:
        for p in layer.parameters():
            print(f"\t {p.shape} has {p.numel()} parameters")
            # torch.Size([256, 784]) has 200704 parameters
            # torch.Size([256]) has 256 parameters
            cnt += p.numel()  # å°†å‚æ•°æ•°é‡ç´¯åŠ è‡³cnt
    # æœ€åæ‰“å°æ¨¡å‹æ€»å‚æ•°æ•°é‡
    print("The model has %d trainable parameters\n" % (cnt))
    # The model has 203530 trainable parameters


# æ‰“å°è¾“å…¥å¼ é‡xç»è¿‡æ¯ä¸€å±‚æ—¶çš„ç»´åº¦å˜åŒ–æƒ…å†µ
def print_forward(model, x):
    print(f"x_origin: {x.shape}")  # xä»ä¸€ä¸ª5*28*28çš„è¾“å…¥å¼ é‡
    print(f"x_origin :\n {x}")

    x = x.view(-1, 28 * 28)  #  ç»è¿‡ view å‡½æ•°ï¼Œå˜æˆäº†ä¸€ä¸ª5*784çš„å¼ é‡
    print(f"after view: {x.shape}")  # after view: torch.Size([5, 784])
    print(f"x_after_viem:  \n", x)
    # x_after_viem:
    #     tensor(
    #         [
    #             [0., 0., 0.,  ..., 0., 0., 0.],
    #             [0., 0., 0.,  ..., 0., 0., 0.],
    #             [0., 0., 0.,  ..., 0., 0., 0.],
    #             [0., 0., 0.,  ..., 0., 0., 0.],
    #             [0., 0., 0.,  ..., 0., 0., 0.]
    #         ]
    #     )

    x = model.layer1(x)  # ç»è¿‡ç¬¬1ä¸ªçº¿æ€§å±‚ï¼Œå¾—åˆ°5*256çš„å¼ é‡
    print(f"after layer1: {x.shape}")  # after layer1: torch.Size([5, 256])
    print(f"x_after_layer1:  \n", x)
    # x_after_layer1:
    #     tensor(
    #         [
    #             [-0.0066,  0.0026, -0.0323,  ...,  0.0350, -0.0037, -0.0300],
    #             [-0.0066,  0.0026, -0.0323,  ...,  0.0350, -0.0037, -0.0300],
    #             [-0.0066,  0.0026, -0.0323,  ...,  0.0350, -0.0037, -0.0300],
    #             [-0.0066,  0.0026, -0.0323,  ...,  0.0350, -0.0037, -0.0300],
    #             [-0.0066,  0.0026, -0.0323,  ...,  0.0350, -0.0037, -0.0300],
    #         ],
    #         grad_fn=<AddmmBackward0>
    #     )

    x = torch.relu(x)  # ç»è¿‡reluå‡½æ•°ï¼Œæ²¡æœ‰å˜åŒ–
    print(f"after relu: {x.shape}")  # after relu: torch.Size([5, 256])
    print(f"x_after_relu:  \n", x)
    # x_after_relu:
    #     tensor(
    #         [
    #             [0.0000, 0.0026, 0.0000,  ..., 0.0350, 0.0000, 0.0000],
    #             [0.0000, 0.0026, 0.0000,  ..., 0.0350, 0.0000, 0.0000],
    #             [0.0000, 0.0026, 0.0000,  ..., 0.0350, 0.0000, 0.0000],
    #             [0.0000, 0.0026, 0.0000,  ..., 0.0350, 0.0000, 0.0000],
    #             [0.0000, 0.0026, 0.0000,  ..., 0.0350, 0.0000, 0.0000],
    #         ],
    #         grad_fn=<ReluBackward0>
    #     )

    x = model.layer2(x)  # ç»è¿‡ç¬¬2ä¸ªçº¿æ€§å±‚ï¼Œå¾—åˆ°ä¸€ä¸ª5*10çš„ç»“æœ
    print(f"after layer2: {x.shape}")  # after layer2: torch.Size([5, 10])
    print(f"x_after_layer2:  \n", x)
    # x_after_layer2:
    #     tensor(
    #         [
    #             [ 0.0108, -0.0418, -0.0581, -0.0305, -0.0432,  0.0187, -0.0390, -0.0652, -0.0271, -0.0069],
    #             [ 0.0108, -0.0418, -0.0581, -0.0305, -0.0432,  0.0187, -0.0390, -0.0652, -0.0271, -0.0069],
    #             [ 0.0108, -0.0418, -0.0581, -0.0305, -0.0432,  0.0187, -0.0390, -0.0652, -0.0271, -0.0069],
    #             [ 0.0108, -0.0418, -0.0581, -0.0305, -0.0432,  0.0187, -0.0390, -0.0652, -0.0271, -0.0069],
    #             [ 0.0108, -0.0418, -0.0581, -0.0305, -0.0432,  0.0187, -0.0390, -0.0652, -0.0271, -0.0069],
    #         ],
    #         grad_fn=<AddmmBackward0>
    #     )


if __name__ == "__main__":
    model = NetWork()  # å®šä¹‰ä¸€ä¸ªNetworkæ¨¡å‹
    print(model)  # å°†å…¶æ‰“å°ï¼Œè§‚å¯Ÿæ‰“å°ç»“æœå¯ä»¥äº†è§£æ¨¡å‹çš„ç»“æ„
    # NetWork(
    #     (layer1): Linear(in_features=784, out_features=256, bias=True)
    #     (layer2): Linear(in_features=256, out_features=10, bias=True)
    # )

    print("")

    print_parameters(model)  # å°†æ¨¡å‹çš„å‚æ•°æ‰“å°å‡ºæ¥
    # layer(layer1) parameters:
    #      torch.Size([256, 784]) has 200704 parameters
    #      torch.Size([256]) has 256 parameters
    # layer(layer2) parameters:
    #         torch.Size([10, 256]) has 2560 parameters
    #         torch.Size([10]) has 10 parameters
    # The model has 203530 trainable parameters

    # note æ‰“å°è¾“å…¥å¼ é‡xç»è¿‡æ¯ä¸€å±‚ç»´åº¦çš„å˜åŒ–æƒ…å†µ
    # * ä»¥ 1é€šé“ï¼ˆçœç•¥é€šé“ç»´åº¦ï¼‰ ä¸ºä¾‹è§£æç»“æ„ğŸ‘‡
    x = torch.zeros([5, 28, 28])  # æ­¤å¤„çœç•¥äº† C=1 ï¼Œå®Œæ•´å†™æ³•æ˜¯ [5, 1, 28, 28]
    # x :
    #     tensor
    #     (
    #         [ <--- æœ€å¤–å±‚æ‹¬å·ï¼šä»£è¡¨æ•´ä¸ª Batch (5å¼ å›¾çš„é›†åˆ)
    #             [ <--- ç¬¬ 1 å¼ å›¾å¼€å§‹
    #                 [0., 0., 0.,  ..., 0., 0., 0.], <--- ç¬¬ 1 å¼ å›¾çš„ ç¬¬ 1 è¡Œ (28ä¸ªåƒç´ )
    #                 [0., 0., 0.,  ..., 0., 0., 0.], <--- ç¬¬ 1 å¼ å›¾çš„ ç¬¬ 2 è¡Œ
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ...,                            <--- (ä¸­é—´çœç•¥äº†20å¤šè¡Œ)
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.], <--- ç¬¬ 1 å¼ å›¾çš„ æœ€å 1 è¡Œ
    #             ], <--- ç¬¬ 1 å¼ å›¾ç»“æŸ

    #             [ <--- ç¬¬ 2 å¼ å›¾å¼€å§‹
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ...,
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #             ], <--- ç¬¬ 2 å¼ å›¾ç»“æŸ

    #             [ <--- ç¬¬ 3 å¼ å›¾å¼€å§‹
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ...,
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #             ], <--- ç¬¬ 3 å¼ å›¾ç»“æŸ

    #             [ <--- ç¬¬ 4 å¼ å›¾å¼€å§‹
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ...,
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #             ], <--- ç¬¬ 4 å¼ å›¾ç»“æŸ

    #             [ <--- ç¬¬ 5 å¼ å›¾å¼€å§‹
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ...,
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #                 [0., 0., 0.,  ..., 0., 0., 0.],
    #             ], <--- ç¬¬ 5 å¼ å›¾ç»“æŸ
    #         ]
    #     )

    # * ä»¥ 1é€šé“ï¼ˆä¸çœç•¥é€šé“ç»´åº¦ï¼‰ ä¸ºä¾‹è§£æç»“æ„ğŸ‘‡
    # x_origin :
    #     tensor(
    #         [
    #             [
    #                 [
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     ...,
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ],
    #             ],

    #             [
    #                 [
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     ...,
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ],
    #             ],

    #             [
    #                 [
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     ...,
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ],
    #             ],

    #             [
    #                 [
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     ...,
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ],
    #             ],

    #             [
    #                 [
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     ...,
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                     [0., 0., 0.,  ..., 0., 0., 0.],
    #                 ],
    #             ],
    #         ],
    #     )

    # * ä»¥ 3é€šé“ ä¸ºä¾‹è§£æç»“æ„ğŸ‘‡
    # y = torch.zeros([2, 3, 10, 10])
    # print(f"y :\n {y}")
    # y :
    #     tensor
    #     (
    #         [ <--- ã€ç¬¬ 1 å±‚æ‹¬å·ã€‘ç»´åº¦ 0 (Batch): åŒ…å« 2 ä¸ªå…ƒç´  (å›¾ç‰‡)

    #             # ================== ç¬¬ 1 å¼ å›¾ (Index 0) å¼€å§‹ ==================
    #             [ <--- ã€ç¬¬ 2 å±‚æ‹¬å·ã€‘ç»´åº¦ 1 (Channel): åŒ…å« 3 ä¸ªå…ƒç´  (é€šé“)

    #                 # --- é€šé“ 0 (æ¯”å¦‚çº¢è‰² R) ---
    #                 [ <--- ã€ç¬¬ 3 å±‚æ‹¬å·ã€‘ç»´åº¦ 2 (Height): åŒ…å« 10 è¡Œ
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], <--- ã€ç¬¬ 4 å±‚æ‹¬å·ã€‘ç»´åº¦ 3 (Width): åŒ…å« 10 ä¸ªåƒç´ å€¼ (ä¸€æ•´è¡Œ)
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                 ],

    #                 # --- é€šé“ 1 (æ¯”å¦‚ç»¿è‰² G) ---
    #                 [
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                 ],

    #                 # --- é€šé“ 2 (æ¯”å¦‚è“è‰² B) ---
    #                 [
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                 ]
    #             ],

    #             # ================== ç¬¬ 2 å¼ å›¾ (Index 1) å¼€å§‹ ==================
    #             [
    #                 [
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]
    #                 ],

    #                 [
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                 ],

    #                 [
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                     [0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
    #                 ]
    #             ]
    #         ]
    #     )

    print_forward(model, x)
    # x: torch.Size([5, 28, 28])
    #   after view: torch.Size([5, 784])
    #   after layer1: torch.Size([5, 256])
    #   after relu: torch.Size([5, 256])
    #   after layer2: torch.Size([5, 10])

    # print_forward(model, y)
